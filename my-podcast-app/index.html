<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ Podcast ç”¢ç”Ÿå™¨</title>

    <!--
    ğŸš¨ğŸš¨ğŸš¨ è§£æ±º Netlify 404 éŒ¯èª¤çš„é—œéµï¼ğŸš¨ğŸš¨ğŸš¨
    è«‹åœ¨ä½ çš„å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹çš„ public è³‡æ–™å¤¾ä¸­ï¼Œå»ºç«‹ä¸€å€‹åç‚º "_redirects" çš„æ–°æª”æ¡ˆã€‚
    é€™å€‹æª”æ¡ˆæ²’æœ‰å‰¯æª”åï¼Œè£¡é¢åªåŒ…å«ä¸€è¡Œå…§å®¹ï¼š
    
    /* /index.html 200

    å®Œæˆå¾Œï¼Œå°‡é€™å€‹æª”æ¡ˆä¸€èµ·æ¨é€åˆ° Git å€‰åº«ã€‚
    é€™å°‡å‘Šè¨´ Netlify ä¼ºæœå™¨ï¼Œå°‡æ‰€æœ‰ç„¡æ•ˆè·¯å¾‘éƒ½å°å‘åˆ°ä½ çš„ index.html é é¢ï¼Œ
    å¾è€Œè§£æ±ºå–®é æ‡‰ç”¨ç¨‹å¼ï¼ˆSPAï¼‰çš„è·¯ç”±å•é¡Œã€‚
    -->

    <!-- Tailwind CSS è…³æœ¬ï¼Œç”¨æ–¼å¿«é€Ÿç¾åŒ–é é¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ä½¿ç”¨ Google Fonts çš„ Inter å­—é«” */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body>

    <!-- é€™æ˜¯ React æ‡‰ç”¨ç¨‹å¼çš„æ ¹å®¹å™¨ -->
    <div id="root"></div>

    <!-- 
    å°‡æ‰€æœ‰ç¨‹å¼ç¢¼åˆä½µåˆ°ä¸€å€‹ type="module" çš„è…³æœ¬å€å¡Šä¸­ã€‚
    é€™ç¢ºä¿äº†æ‰€æœ‰æ¨¡çµ„å’Œè®Šæ•¸éƒ½èƒ½æ­£ç¢ºåœ°è¢«è¼‰å…¥å’Œå­˜å–ã€‚
    -->
    <script type="module">
        import React, { useState, useEffect, useRef } from 'https://unpkg.com/react@18/umd/react.production.min.js';
        import ReactDOM from 'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js';
        
        // å°å…¥ Firebase å‡½å¼åº«
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ğŸš¨ è«‹å‹¿å…¬é–‹ä½ çš„ API é‡‘é‘°ã€‚æ­¤è™•åƒ…ç‚ºç¤ºç¯„ç”¨é€”ã€‚
        const GEMINI_API_KEY = "AIzaSyBRDwcceJ4PhOsie2gso3TU6XDH9wQq-p0";

        // Firestore é…ç½®èˆ‡åˆå§‹åŒ–
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // ä¸»æ‡‰ç”¨ç¨‹å¼çµ„ä»¶
        const App = () => {
            // ç‹€æ…‹ç®¡ç†
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [textInput, setTextInput] = useState('');
            const [isConverting, setIsConverting] = useState(false);
            const [message, setMessage] = useState('');
            const [files, setFiles] = useState([]);
            const [audioUrl, setAudioUrl] = useState('');
            const [playbackRate, setPlaybackRate] = useState(1.0); // æ–°å¢æ’­æ”¾é€Ÿåº¦ç‹€æ…‹
            const [categories, setCategories] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState('');
            const [newCategoryName, setNewCategoryName] = useState('');
            const audioRef = useRef(null); // ç”¨æ–¼æ§åˆ¶ audio å…ƒç´ 

            // Firebase åˆå§‹åŒ–å’Œèº«ä»½é©—è­‰
            useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        const app = initializeApp(firebaseConfig);
                        const firestoreDb = getFirestore(app);
                        const firestoreAuth = getAuth(app);
                        setDb(firestoreDb);
                        setAuth(firestoreAuth);

                        onAuthStateChanged(firestoreAuth, (user) => {
                            if (user) {
                                setUserId(user.uid);
                            } else {
                                signInAnonymously(firestoreAuth).then((cred) => {
                                    setUserId(cred.user.uid);
                                });
                            }
                        });

                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            await signInWithCustomToken(firestoreAuth, initialAuthToken);
                        } else {
                            await signInAnonymously(firestoreAuth);
                        }
                    } catch (e) {
                        console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                        setMessage("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®ã€‚");
                    }
                };
                initializeFirebase();
            }, []);

            // å¯¦æ™‚ç›£è½ Firestore ä¸­çš„æª”æ¡ˆåˆ—è¡¨å’Œåˆ†é¡
            useEffect(() => {
                if (!db || !userId) return;

                // ç›£è½æª”æ¡ˆåˆ—è¡¨
                const filesPath = `artifacts/${appId}/public/data/files`;
                const qFiles = query(collection(db, filesPath));
                const unsubscribeFiles = onSnapshot(qFiles, (snapshot) => {
                    const fetchedFiles = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setFiles(fetchedFiles);
                }, (error) => {
                    console.error("ç›£è½æª”æ¡ˆåˆ—è¡¨å¤±æ•—:", error);
                    setMessage("ç„¡æ³•è¼‰å…¥æª”æ¡ˆåˆ—è¡¨ã€‚");
                });

                // ç›£è½åˆ†é¡åˆ—è¡¨
                const categoriesPath = `artifacts/${appId}/public/data/categories`;
                const qCategories = query(collection(db, categoriesPath));
                const unsubscribeCategories = onSnapshot(qCategories, (snapshot) => {
                    const fetchedCategories = snapshot.docs.map(doc => ({
                        id: doc.id,
                        name: doc.data().name
                    }));
                    setCategories(fetchedCategories);
                }, (error) => {
                    console.error("ç›£è½åˆ†é¡åˆ—è¡¨å¤±æ•—:", error);
                    setMessage("ç„¡æ³•è¼‰å…¥åˆ†é¡åˆ—è¡¨ã€‚");
                });

                return () => {
                    unsubscribeFiles();
                    unsubscribeCategories();
                };
            }, [db, userId]);

            // ç•¶æ’­æ”¾é€Ÿåº¦æ”¹è®Šæ™‚ï¼Œæ›´æ–° audio å…ƒç´ çš„ playbackRate
            useEffect(() => {
                if (audioRef.current) {
                    audioRef.current.playbackRate = playbackRate;
                }
            }, [playbackRate]);

            // --- å·¥å…·å‡½å¼ ---
            const base64ToArrayBuffer = (base64) => {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            };

            const pcmToWav = (pcmData, sampleRate) => {
                const numSamples = pcmData.length;
                const buffer = new ArrayBuffer(44 + numSamples * 2);
                const view = new DataView(buffer);
                let offset = 0;
                const writeString = (str) => {
                    for (let i = 0; i < str.length; i++) {
                        view.setUint8(offset + i, str.charCodeAt(i));
                    }
                    offset += str.length;
                };
                const writeUint32 = (val) => {
                    view.setUint32(offset, val, true);
                    offset += 4;
                };
                const writeUint16 = (val) => {
                    view.setUint16(offset, val, true);
                    offset += 2;
                };

                writeString('RIFF');
                writeUint32(36 + numSamples * 2);
                writeString('WAVE');
                writeString('fmt ');
                writeUint32(16);
                writeUint16(1);
                writeUint16(1);
                writeUint32(sampleRate);
                writeUint32(sampleRate * 2);
                writeUint16(2);
                writeUint16(16);
                writeString('data');
                writeUint32(numSamples * 2);
                
                for (let i = 0; i < numSamples; i++) {
                    view.setInt16(offset, pcmData[i], true);
                    offset += 2;
                }
                return new Blob([view], { type: 'audio/wav' });
            };

            // --- åŠŸèƒ½å‡½å¼ ---

            // æ–°å¢è³‡æ–™å¤¾
            const handleAddCategory = async () => {
                if (!db || !newCategoryName.trim()) {
                    setMessage("è«‹è¼¸å…¥è³‡æ–™å¤¾åç¨±ï¼");
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/categories`), {
                        name: newCategoryName.trim(),
                        createdAt: Date.now(),
                    });
                    setNewCategoryName('');
                    setMessage(`å·²æ–°å¢è³‡æ–™å¤¾ï¼š${newCategoryName}`);
                } catch (error) {
                    console.error("æ–°å¢è³‡æ–™å¤¾å¤±æ•—:", error);
                    setMessage("æ–°å¢è³‡æ–™å¤¾å¤±æ•—ã€‚");
                }
            };

            // å°‡æ–‡å­—è½‰æ›ç‚ºèªéŸ³ä¸¦ä¸Šå‚³åˆ° Firestore
            const handleConvert = async () => {
                if (isConverting || !textInput.trim() || !selectedCategory) {
                    setMessage("è«‹è¼¸å…¥æ–‡å­—ä¸¦é¸æ“‡è³‡æ–™å¤¾ï¼");
                    return;
                }

                setIsConverting(true);
                setMessage("è½‰æ›ä¸­...è«‹ç¨å€™...");
                
                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
                    const payload = {
                        contents: [{ parts: [{ text: textInput }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (!audioData || !mimeType) {
                        throw new Error("API å›å‚³è³‡æ–™ä¸å®Œæ•´ã€‚");
                    }
                    
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    const pcmArrayBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmArrayBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    const fileUrl = URL.createObjectURL(wavBlob);
                    const fileName = `Podcast_${Date.now()}.wav`;

                    // å°‡æª”æ¡ˆè³‡è¨Šæ–°å¢åˆ° Firestoreï¼ŒåŒ…å«è³‡æ–™å¤¾è³‡è¨Š
                    await addDoc(collection(db, `artifacts/${appId}/public/data/files`), {
                        name: fileName,
                        url: fileUrl,
                        createdAt: Date.now(),
                        userId: userId,
                        category: selectedCategory,
                    });

                    setMessage("è½‰æ›ä¸¦å„²å­˜æˆåŠŸï¼");
                    setTextInput('');
                } catch (error) {
                    console.error("è½‰æ›å¤±æ•—:", error);
                    setMessage(`è½‰æ›å¤±æ•—: ${error.message}`);
                } finally {
                    setIsConverting(false);
                }
            };

            // æ‰‹å‹•ä¸Šå‚³æª”æ¡ˆ
            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file || !selectedCategory) {
                    setMessage("è«‹é¸æ“‡ä¸€å€‹æª”æ¡ˆä¸¦é¸æ“‡è³‡æ–™å¤¾ï¼");
                    return;
                }

                setMessage("ä¸Šå‚³ä¸­...");
                
                try {
                    const fileUrl = URL.createObjectURL(file);
                    const fileName = file.name;

                    await addDoc(collection(db, `artifacts/${appId}/public/data/files`), {
                        name: fileName,
                        url: fileUrl,
                        createdAt: Date.now(),
                        userId: userId,
                        category: selectedCategory,
                    });

                    setMessage("ä¸Šå‚³æˆåŠŸï¼");
                } catch (error) {
                    console.error("ä¸Šå‚³å¤±æ•—:", error);
                    setMessage(`ä¸Šå‚³å¤±æ•—: ${error.message}`);
                }
            };

            // åˆªé™¤æª”æ¡ˆ
            const handleDelete = async (id, url) => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/files`, id));
                    URL.revokeObjectURL(url);
                    setMessage("æª”æ¡ˆå·²åˆªé™¤ï¼");
                } catch (error) {
                    console.error("åˆªé™¤å¤±æ•—:", error);
                    setMessage("åˆªé™¤å¤±æ•—ã€‚");
                }
            };

            // æ’­æ”¾æª”æ¡ˆ
            const handlePlay = (url) => {
                setAudioUrl(url);
                setMessage("æ­£åœ¨æ’­æ”¾éŸ³æª”...");
            };

            const App = () => {
                // ç‹€æ…‹ç®¡ç†
                const [db, setDb] = useState(null);
                const [auth, setAuth] = useState(null);
                const [userId, setUserId] = useState(null);
                const [textInput, setTextInput] = useState('');
                const [isConverting, setIsConverting] = useState(false);
                const [message, setMessage] = useState('');
                const [files, setFiles] = useState([]);
                const [audioUrl, setAudioUrl] = useState('');
                const [playbackRate, setPlaybackRate] = useState(1.0);
                const [categories, setCategories] = useState([]);
                const [selectedCategory, setSelectedCategory] = useState('');
                const [newCategoryName, setNewCategoryName] = useState('');
                const audioRef = useRef(null);

                // Firebase åˆå§‹åŒ–å’Œèº«ä»½é©—è­‰
                useEffect(() => {
                    const initializeFirebase = async () => {
                        try {
                            const app = initializeApp(firebaseConfig);
                            const firestoreDb = getFirestore(app);
                            const firestoreAuth = getAuth(app);
                            setDb(firestoreDb);
                            setAuth(firestoreAuth);

                            onAuthStateChanged(firestoreAuth, (user) => {
                                if (user) {
                                    setUserId(user.uid);
                                } else {
                                    signInAnonymously(firestoreAuth).then((cred) => {
                                        setUserId(cred.user.uid);
                                    });
                                }
                            });

                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (initialAuthToken) {
                                await signInWithCustomToken(firestoreAuth, initialAuthToken);
                            } else {
                                await signInAnonymously(firestoreAuth);
                            }
                        } catch (e) {
                            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                            setMessage("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®ã€‚");
                        }
                    };
                    initializeFirebase();
                }, []);

                // å¯¦æ™‚ç›£è½ Firestore
                useEffect(() => {
                    if (!db || !userId) return;

                    const filesPath = `artifacts/${appId}/public/data/files`;
                    const qFiles = query(collection(db, filesPath));
                    const unsubscribeFiles = onSnapshot(qFiles, (snapshot) => {
                        const fetchedFiles = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setFiles(fetchedFiles);
                    }, (error) => {
                        console.error("ç›£è½æª”æ¡ˆåˆ—è¡¨å¤±æ•—:", error);
                        setMessage("ç„¡æ³•è¼‰å…¥æª”æ¡ˆåˆ—è¡¨ã€‚");
                    });

                    const categoriesPath = `artifacts/${appId}/public/data/categories`;
                    const qCategories = query(collection(db, categoriesPath));
                    const unsubscribeCategories = onSnapshot(qCategories, (snapshot) => {
                        const fetchedCategories = snapshot.docs.map(doc => ({
                            id: doc.id,
                            name: doc.data().name
                        }));
                        setCategories(fetchedCategories);
                    }, (error) => {
                        console.error("ç›£è½åˆ†é¡åˆ—è¡¨å¤±æ•—:", error);
                        setMessage("ç„¡æ³•è¼‰å…¥åˆ†é¡åˆ—è¡¨ã€‚");
                    });

                    return () => {
                        unsubscribeFiles();
                        unsubscribeCategories();
                    };
                }, [db, userId]);

                // ç•¶æ’­æ”¾é€Ÿåº¦æ”¹è®Šæ™‚ï¼Œæ›´æ–° audio å…ƒç´ çš„ playbackRate
                useEffect(() => {
                    if (audioRef.current) {
                        audioRef.current.playbackRate = playbackRate;
                    }
                }, [playbackRate]);

                // å…¶ä»–å‡½å¼...
                const base64ToArrayBuffer = (base64) => {
                    const binaryString = window.atob(base64);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    return bytes.buffer;
                };

                const pcmToWav = (pcmData, sampleRate) => {
                    const numSamples = pcmData.length;
                    const buffer = new ArrayBuffer(44 + numSamples * 2);
                    const view = new DataView(buffer);
                    let offset = 0;
                    const writeString = (str) => {
                        for (let i = 0; i < str.length; i++) {
                            view.setUint8(offset + i, str.charCodeAt(i));
                        }
                        offset += str.length;
                    };
                    const writeUint32 = (val) => {
                        view.setUint32(offset, val, true);
                        offset += 4;
                    };
                    const writeUint16 = (val) => {
                        view.setUint16(offset, val, true);
                        offset += 2;
                    };
                    writeString('RIFF');
                    writeUint32(36 + numSamples * 2);
                    writeString('WAVE');
                    writeString('fmt ');
                    writeUint32(16);
                    writeUint16(1);
                    writeUint16(1);
                    writeUint32(sampleRate);
                    writeUint32(sampleRate * 2);
                    writeUint16(2);
                    writeUint16(16);
                    writeString('data');
                    writeUint32(numSamples * 2);
                    
                    for (let i = 0; i < numSamples; i++) {
                        view.setInt16(offset, pcmData[i], true);
                        offset += 2;
                    }
                    return new Blob([view], { type: 'audio/wav' });
                };

                const handleAddCategory = async () => {
                    if (!db || !newCategoryName.trim()) {
                        setMessage("è«‹è¼¸å…¥è³‡æ–™å¤¾åç¨±ï¼");
                        return;
                    }
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/categories`), {
                            name: newCategoryName.trim(),
                            createdAt: Date.now(),
                        });
                        setNewCategoryName('');
                        setMessage(`å·²æ–°å¢è³‡æ–™å¤¾ï¼š${newCategoryName}`);
                    } catch (error) {
                        console.error("æ–°å¢è³‡æ–™å¤¾å¤±æ•—:", error);
                        setMessage("æ–°å¢è³‡æ–™å¤¾å¤±æ•—ã€‚");
                    }
                };

                const handleConvert = async () => {
                    if (isConverting || !textInput.trim() || !selectedCategory) {
                        setMessage("è«‹è¼¸å…¥æ–‡å­—ä¸¦é¸æ“‡è³‡æ–™å¤¾ï¼");
                        return;
                    }

                    setIsConverting(true);
                    setMessage("è½‰æ›ä¸­...è«‹ç¨å€™...");
                    
                    try {
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
                        const payload = {
                            contents: [{ parts: [{ text: textInput }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                            },
                            model: "gemini-2.5-flash-preview-tts"
                        };

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;

                        if (!audioData || !mimeType) {
                            throw new Error("API å›å‚³è³‡æ–™ä¸å®Œæ•´ã€‚");
                        }
                        
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                        const pcmArrayBuffer = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmArrayBuffer);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        
                        const fileUrl = URL.createObjectURL(wavBlob);
                        const fileName = `Podcast_${Date.now()}.wav`;

                        await addDoc(collection(db, `artifacts/${appId}/public/data/files`), {
                            name: fileName,
                            url: fileUrl,
                            createdAt: Date.now(),
                            userId: userId,
                            category: selectedCategory,
                        });

                        setMessage("è½‰æ›ä¸¦å„²å­˜æˆåŠŸï¼");
                        setTextInput('');
                    } catch (error) {
                        console.error("è½‰æ›å¤±æ•—:", error);
                        setMessage(`è½‰æ›å¤±æ•—: ${error.message}`);
                    } finally {
                        setIsConverting(false);
                    }
                };

                const handleUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file || !selectedCategory) {
                        setMessage("è«‹é¸æ“‡ä¸€å€‹æª”æ¡ˆä¸¦é¸æ“‡è³‡æ–™å¤¾ï¼");
                        return;
                    }
                    setMessage("ä¸Šå‚³ä¸­...");
                    
                    try {
                        const fileUrl = URL.createObjectURL(file);
                        const fileName = file.name;

                        await addDoc(collection(db, `artifacts/${appId}/public/data/files`), {
                            name: fileName,
                            url: fileUrl,
                            createdAt: Date.now(),
                            userId: userId,
                            category: selectedCategory,
                        });

                        setMessage("ä¸Šå‚³æˆåŠŸï¼");
                    } catch (error) {
                        console.error("ä¸Šå‚³å¤±æ•—:", error);
                        setMessage(`ä¸Šå‚³å¤±æ•—: ${error.message}`);
                    }
                };

                const handleDelete = async (id, url) => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/files`, id));
                        URL.revokeObjectURL(url);
                        setMessage("æª”æ¡ˆå·²åˆªé™¤ï¼");
                    } catch (error) {
                        console.error("åˆªé™¤å¤±æ•—:", error);
                        setMessage("åˆªé™¤å¤±æ•—ã€‚");
                    }
                };

                const handlePlay = (url) => {
                    setAudioUrl(url);
                    setMessage("æ­£åœ¨æ’­æ”¾éŸ³æª”...");
                };

                return (
                    <div className="bg-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center font-sans">
                        <div className="bg-white rounded-xl shadow-lg p-6 sm:p-10 w-full max-w-3xl">
                            <h1 className="text-3xl font-bold text-center text-gray-800 mb-6">æˆ‘çš„ Podcast ç”¢ç”Ÿå™¨</h1>
                            
                            {userId && (
                                <div className="bg-gray-200 p-2 rounded-lg text-sm text-gray-600 text-center mb-4">
                                    <span className="font-semibold">ä½¿ç”¨è€… ID:</span> {userId}
                                </div>
                            )}

                            {/* é€šçŸ¥å€å¡Š */}
                            {message && (
                                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-md" role="alert">
                                    {message}
                                </div>
                            )}

                            {/* è³‡æ–™å¤¾ç®¡ç†å€å¡Š */}
                            <h2 className="text-xl font-semibold text-gray-700 mb-3">ç®¡ç†è³‡æ–™å¤¾</h2>
                            <div className="flex flex-col sm:flex-row items-center gap-4 mb-6">
                                <input
                                    type="text"
                                    className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200"
                                    placeholder="æ–°å¢è³‡æ–™å¤¾åç¨±..."
                                    value={newCategoryName}
                                    onChange={(e) => setNewCategoryName(e.target.value)}
                                />
                                <button
                                    className="px-6 py-2 rounded-lg text-white font-medium bg-gray-600 hover:bg-gray-700 transition-all duration-200"
                                    onClick={handleAddCategory}
                                >
                                    æ–°å¢
                                </button>
                            </div>

                            {/* æª”æ¡ˆæ“ä½œå€å¡Š - é¸æ“‡è³‡æ–™å¤¾ */}
                            <h2 className="text-xl font-semibold text-gray-700 mb-3">é¸æ“‡è³‡æ–™å¤¾</h2>
                            <div className="flex flex-col sm:flex-row items-center gap-4 mb-6">
                                <select
                                    className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200"
                                    value={selectedCategory}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                >
                                    <option value="">-- è«‹é¸æ“‡è³‡æ–™å¤¾ --</option>
                                    {categories.map((cat) => (
                                        <option key={cat.id} value={cat.name}>{cat.name}</option>
                                    ))}
                                </select>
                            </div>

                            {/* æ–‡å­—è½‰èªéŸ³å€å¡Š */}
                            <h2 className="text-xl font-semibold text-gray-700 mb-3">æ–‡å­—è½‰èªéŸ³</h2>
                            <div className="flex flex-col sm:flex-row gap-4 mb-6">
                                <textarea
                                    className="flex-grow p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all duration-200 resize-none"
                                    placeholder="è¼¸å…¥æ‚¨æƒ³è½‰æ›çš„æ–‡å­—..."
                                    value={textInput}
                                    onChange={(e) => setTextInput(e.target.value)}
                                    rows="4"
                                ></textarea>
                                <button
                                    className={`px-6 py-2 rounded-lg text-white font-medium transition-all duration-200 ${isConverting ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                                    onClick={handleConvert}
                                    disabled={isConverting || !selectedCategory}
                                >
                                    {isConverting ? 'è½‰æ›ä¸­...' : 'è½‰æ›ä¸¦å„²å­˜'}
                                </button>
                            </div>

                            {/* æª”æ¡ˆä¸Šå‚³å€å¡Š */}
                            <h2 className="text-xl font-semibold text-gray-700 mb-3">ä¸Šå‚³éŸ³æª”</h2>
                            <div className="flex flex-col sm:flex-row items-center gap-4 mb-6">
                                <input
                                    type="file"
                                    accept="audio/*"
                                    onChange={handleUpload}
                                    className="flex-grow text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                />
                            </div>

                            {/* æ’­æ”¾å™¨èˆ‡é€Ÿåº¦èª¿æ•´ */}
                            <div className="flex flex-col sm:flex-row items-center justify-between mb-4">
                                <h2 className="text-xl font-semibold text-gray-700 mb-2 sm:mb-0">æ’­æ”¾å™¨</h2>
                                <div className="flex items-center gap-2">
                                    <label className="text-gray-700 font-medium">æ’­æ”¾é€Ÿåº¦:</label>
                                    <select
                                        className="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200"
                                        value={playbackRate}
                                        onChange={(e) => setPlaybackRate(e.target.value)}
                                    >
                                        <option value="0.5">0.5x</option>
                                        <option value="0.75">0.75x</option>
                                        <option value="1.0">1.0x (æ¨™æº–)</option>
                                        <option value="1.25">1.25x</option>
                                        <option value="1.5">1.5x</option>
                                        <option value="1.75">1.75x</option>
                                        <option value="2.0">2.0x</option>
                                    </select>
                                </div>
                            </div>
                            <audio ref={audioRef} controls src={audioUrl} className="w-full"></audio>

                            {/* æª”æ¡ˆåˆ—è¡¨ */}
                            <h2 className="text-xl font-semibold text-gray-700 mt-6 mb-3">æˆ‘çš„æª”æ¡ˆåˆ—è¡¨</h2>
                            <div className="bg-gray-50 rounded-lg p-4 mb-6">
                                {files.length > 0 ? (
                                    <ul className="divide-y divide-gray-200">
                                        {files.map((file) => (
                                            <li key={file.id} className="py-3 flex flex-col sm:flex-row items-start sm:items-center justify-between">
                                                <div className="sm:truncate sm:flex-1 mb-2 sm:mb-0 mr-4">
                                                    <span className="text-gray-800 font-medium">{file.name}</span>
                                                    {file.category && (
                                                        <span className="text-xs text-gray-500 ml-2 px-2 py-1 bg-gray-200 rounded-full">{file.category}</span>
                                                    )}
                                                </div>
                                                <div className="flex flex-wrap gap-2">
                                                    <button
                                                        className="px-4 py-2 rounded-md bg-green-500 text-white text-sm hover:bg-green-600 transition-colors duration-200"
                                                        onClick={() => handlePlay(file.url)}
                                                    >
                                                        æ’­æ”¾
                                                    </button>
                                                    <a href={file.url} download={file.name}>
                                                        <button className="px-4 py-2 rounded-md bg-indigo-500 text-white text-sm hover:bg-indigo-600 transition-colors duration-200">
                                                            ä¸‹è¼‰
                                                        </button>
                                                    </a>
                                                    <button
                                                        className="px-4 py-2 rounded-md bg-red-500 text-white text-sm hover:bg-red-600 transition-colors duration-200"
                                                        onClick={() => handleDelete(file.id, file.url)}
                                                    >
                                                        åˆªé™¤
                                                    </button>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <p className="text-gray-500 italic">ç›®å‰æ²’æœ‰ä»»ä½•æª”æ¡ˆã€‚è«‹è½‰æ›æ–‡å­—æˆ–ä¸Šå‚³æª”æ¡ˆã€‚</p>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            ReactDOM.render(<App />, document.getElementById('root'));
        </script>

    </body>
</html>