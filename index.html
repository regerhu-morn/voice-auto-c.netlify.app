<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的 Podcast 產生器</title>

    <!-- Tailwind CSS 腳本，用於美化頁面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 使用 Google Fonts 的 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center font-sans">

    <!-- 這是應用程式的主要容器，將所有 UI 元素動態新增到此處 -->
    <div id="app-container" class="bg-white rounded-xl shadow-lg p-6 sm:p-10 w-full max-w-3xl"></div>

    <!-- 主應用程式腳本 -->
    <script type="module">
        // 🚨 請勿公開你的 API 金鑰。此處由環境自動提供
        const GEMINI_API_KEY = "";

        let allFiles = JSON.parse(localStorage.getItem('podcastFiles')) || [];
        let categories = JSON.parse(localStorage.getItem('podcastCategories')) || [];
        let displayedFiles = [...allFiles]; // 預設顯示所有檔案
        let audioUrl = '';
        let playbackRate = 1.0;
        let audioRef = new Audio();
        let isConverting = false;

        // --- 工具函式 ---
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const numSamples = pcmData.length;
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);
            let offset = 0;
            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            };
            const writeUint32 = (val) => {
                view.setUint32(offset, val, true);
                offset += 4;
            };
            const writeUint16 = (val) => {
                view.setUint16(offset, val, true);
                offset += 2;
            };

            writeString('RIFF');
            writeUint32(36 + numSamples * 2);
            writeString('WAVE');
            writeString('fmt ');
            writeUint32(16);
            writeUint16(1);
            writeUint16(1);
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2);
            writeUint16(2);
            writeUint16(16);
            writeString('data');
            writeUint32(numSamples * 2);
            
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        };
        
        // --- UI 更新與事件處理 ---

        const showMessage = (text) => {
            const messageEl = document.getElementById('message-box');
            if (messageEl) {
                messageEl.textContent = text;
                messageEl.style.display = 'block';
            }
        };

        const renderUI = () => {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;
            
            appContainer.innerHTML = `
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">我的 Podcast 產生器</h1>
                <div id="message-box" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-md" role="alert" style="display: none;"></div>

                <!-- 資料夾管理區塊 -->
                <h2 class="text-xl font-semibold text-gray-700 mb-3">管理資料夾</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                    <input id="new-category-input" type="text" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200" placeholder="新增資料夾名稱...">
                    <button id="add-category-btn" class="px-6 py-2 rounded-lg text-white font-medium bg-gray-600 hover:bg-gray-700 transition-all duration-200">新增</button>
                </div>

                <!-- 檔案操作區塊 - 選擇資料夾 -->
                <h2 class="text-xl font-semibold text-gray-700 mb-3">選擇資料夾</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                    <select id="category-select" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200">
                        <option value="">-- 顯示所有檔案 --</option>
                        ${categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('')}
                    </select>
                </div>

                <!-- 文字轉語音區塊 -->
                <h2 class="text-xl font-semibold text-gray-700 mb-3">文字轉語音</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <textarea id="text-input" class="flex-grow p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all duration-200 resize-none" placeholder="輸入您想轉換的文字..." rows="4"></textarea>
                    <button id="convert-btn" class="px-6 py-2 rounded-lg text-white font-medium transition-all duration-200 bg-blue-600 hover:bg-blue-700">轉換並儲存</button>
                </div>

                <!-- 檔案上傳區塊 -->
                <h2 class="text-xl font-semibold text-gray-700 mb-3">上傳音檔</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                    <input id="file-upload-input" type="file" accept="audio/*" class="flex-grow text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <!-- 播放器與速度調整 -->
                <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2 sm:mb-0">播放器</h2>
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 font-medium">播放速度:</label>
                        <select id="playback-rate-select" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1.0" selected>1.0x (標準)</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="1.75">1.75x</option>
                            <option value="2.0">2.0x</option>
                        </select>
                    </div>
                </div>
                <audio id="audio-player" controls class="w-full"></audio>

                <!-- 檔案列表 -->
                <h2 class="text-xl font-semibold text-gray-700 mt-6 mb-3">我的檔案列表</h2>
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <ul id="files-list" class="divide-y divide-gray-200">
                        ${displayedFiles.length > 0 ? displayedFiles.map(file => `
                            <li class="py-3 flex flex-col sm:flex-row items-start sm:items-center justify-between">
                                <div class="sm:truncate sm:flex-1 mb-2 sm:mb-0 mr-4">
                                    <span class="text-gray-800 font-medium">${file.name}</span>
                                    ${file.category ? `<span class="text-xs text-gray-500 ml-2 px-2 py-1 bg-gray-200 rounded-full">${file.category}</span>` : ''}
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button class="play-btn px-4 py-2 rounded-md bg-green-500 text-white text-sm hover:bg-green-600 transition-colors duration-200" data-url="${file.url}">播放</button>
                                    <a href="${file.url}" download="${file.name}">
                                        <button class="px-4 py-2 rounded-md bg-indigo-500 text-white text-sm hover:bg-indigo-600 transition-colors duration-200">下載</button>
                                    </a>
                                    <button class="delete-btn px-4 py-2 rounded-md bg-red-500 text-white text-sm hover:bg-red-600 transition-colors duration-200" data-id="${file.id}" data-url="${file.url}">刪除</button>
                                </div>
                            </li>
                        `).join('') : '<p class="text-gray-500 italic">目前沒有任何檔案。請轉換文字或上傳檔案。</p>'}
                    </ul>
                </div>
            `;
            
            // 重新繫結事件監聽器
            setupEventListeners();
        };

        const setupEventListeners = () => {
            const addCategoryBtn = document.getElementById('add-category-btn');
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener('click', handleAddCategory);
            }

            const convertBtn = document.getElementById('convert-btn');
            if (convertBtn) {
                convertBtn.addEventListener('click', handleConvert);
            }

            const fileUploadInput = document.getElementById('file-upload-input');
            if (fileUploadInput) {
                fileUploadInput.addEventListener('change', handleUpload);
            }

            const playbackRateSelect = document.getElementById('playback-rate-select');
            if (playbackRateSelect) {
                playbackRateSelect.value = playbackRate;
                playbackRateSelect.addEventListener('change', (e) => {
                    playbackRate = parseFloat(e.target.value);
                    if (audioRef) {
                        audioRef.playbackRate = playbackRate;
                    }
                });
            }

            const categorySelect = document.getElementById('category-select');
            if (categorySelect) {
                categorySelect.addEventListener('change', handleCategoryFilter);
            }

            const audioPlayer = document.getElementById('audio-player');
            if (audioPlayer) {
                audioRef = audioPlayer;
                if (audioUrl) {
                    audioRef.src = audioUrl;
                }
                audioRef.playbackRate = playbackRate;
            }
            
            const filesList = document.getElementById('files-list');
            if (filesList) {
                filesList.querySelectorAll('.play-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const url = e.target.dataset.url;
                        audioUrl = url;
                        audioRef.src = audioUrl;
                        audioRef.play();
                        showMessage("正在播放音檔...");
                    });
                });
                filesList.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const url = e.target.dataset.url;
                        handleDelete(id, url);
                    });
                });
            }
        };

        // --- 功能函式 ---

        const saveToLocalStorage = () => {
            localStorage.setItem('podcastFiles', JSON.stringify(allFiles));
            localStorage.setItem('podcastCategories', JSON.stringify(categories));
        };

        const handleCategoryFilter = () => {
            const selectedCategory = document.getElementById('category-select').value;
            if (selectedCategory) {
                displayedFiles = allFiles.filter(file => file.category === selectedCategory);
            } else {
                displayedFiles = [...allFiles];
            }
            renderUI();
        };

        const handleAddCategory = () => {
            const newCategoryInput = document.getElementById('new-category-input');
            const newCategoryName = newCategoryInput.value.trim();
            if (!newCategoryName) {
                showMessage("請輸入資料夾名稱！");
                return;
            }

            const newCategory = { id: Date.now(), name: newCategoryName };
            categories.push(newCategory);
            saveToLocalStorage();
            newCategoryInput.value = '';
            renderUI();
            showMessage(`已新增資料夾：${newCategoryName}`);
        };

        const handleConvert = async () => {
            const textInputEl = document.getElementById('text-input');
            const textInput = textInputEl.value.trim();
            const selectedCategory = document.getElementById('category-select').value;
            
            if (isConverting || !textInput || !selectedCategory) {
                showMessage("請輸入文字並選擇資料夾！");
                return;
            }

            isConverting = true;
            const convertBtn = document.getElementById('convert-btn');
            convertBtn.textContent = '轉換中...';
            convertBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            convertBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            convertBtn.disabled = true;
            showMessage("轉換中...請稍候...");
            
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
                const payload = {
                    contents: [{ parts: [{ text: textInput }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (!audioData || !mimeType) {
                    throw new Error("API 回傳資料不完整。");
                }
                
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                const pcmArrayBuffer = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmArrayBuffer);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                
                const fileUrl = URL.createObjectURL(wavBlob);
                const fileName = `Podcast_${Date.now()}.wav`;

                const newFile = {
                    id: Date.now(),
                    name: fileName,
                    url: fileUrl,
                    category: selectedCategory,
                };

                allFiles.unshift(newFile); // 在列表前面新增
                saveToLocalStorage();
                handleCategoryFilter(); // 更新顯示的檔案列表
                renderUI();

                showMessage("轉換並儲存成功！");
                textInputEl.value = '';
            } catch (error) {
                console.error("轉換失敗:", error);
                showMessage(`轉換失敗: ${error.message}`);
            } finally {
                isConverting = false;
                convertBtn.textContent = '轉換並儲存';
                convertBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                convertBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                convertBtn.disabled = false;
            }
        };

        const handleUpload = (e) => {
            const file = e.target.files[0];
            const selectedCategory = document.getElementById('category-select').value;
            if (!file || !selectedCategory) {
                showMessage("請選擇一個檔案並選擇資料夾！");
                return;
            }

            showMessage("上傳中...");
            
            try {
                const fileUrl = URL.createObjectURL(file);
                const fileName = file.name;

                const newFile = {
                    id: Date.now(),
                    name: fileName,
                    url: fileUrl,
                    category: selectedCategory,
                };

                allFiles.unshift(newFile);
                saveToLocalStorage();
                handleCategoryFilter();
                renderUI();

                showMessage("上傳成功！");
            } catch (error) {
                console.error("上傳失敗:", error);
                showMessage(`上傳失敗: ${error.message}`);
            }
        };

        const handleDelete = (id, url) => {
            allFiles = allFiles.filter(file => file.id != id);
            saveToLocalStorage();
            URL.revokeObjectURL(url);
            handleCategoryFilter();
            renderUI();
            showMessage("檔案已刪除！");
        };

        // --- 應用程式初始化 ---
        window.onload = () => {
            renderUI();
        };
    </script>
</body>
</html>
