<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字轉 Podcast (Gemini)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* 基礎樣式和響應式設計 */
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 900px; margin: auto; padding: 30px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); }
        
        /* 標題與分隔線 */
        h1, h2 { color: #2c3e50; font-weight: 600; margin-top: 0; }
        hr { border: none; border-top: 1px solid #e0e0e0; margin: 30px 0; }
        
        /* 輸入與按鈕樣式 */
        textarea { width: 100%; height: 120px; margin-bottom: 15px; padding: 15px; border: 1px solid #dcdfe6; border-radius: 8px; font-size: 16px; resize: vertical; box-sizing: border-box; transition: border-color 0.3s; }
        textarea:focus { outline: none; border-color: #4a90e2; }
        button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; background-color: #4a90e2; color: #fff; font-size: 16px; font-weight: 600; transition: background-color 0.3s, transform 0.2s; }
        button:hover { background-color: #357bd8; transform: translateY(-2px); }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }

        /* 檔案列表與項目樣式 */
        #file-list { list-style: none; padding: 0; margin: 0; }
        .file-item { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .file-item:last-child { border-bottom: none; }
        .file-info { flex-grow: 1; min-width: 0; word-break: break-all; margin-right: 10px; }
        .file-actions { display: flex; flex-shrink: 0; gap: 8px; }
        
        /* 播放器與通知 */
        audio { width: 100%; margin-top: 20px; }
        #notification { padding: 15px; margin-top: 20px; border-radius: 8px; background-color: #e6f7ff; color: #357bd8; text-align: center; display: none; }
        
        /* 響應式調整 */
        @media (max-width: 600px) {
            .container { padding: 20px; }
            .btn-group { flex-direction: column; }
            .file-item { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>文字轉 Podcast (Gemini)</h1>
        
        <!-- 文字轉語音區塊 -->
        <textarea id="text-input" placeholder="請輸入您想轉換成 Podcast 的文字..."></textarea>
        <div class="btn-group">
            <button id="convert-btn">轉換成音檔</button>
            <button id="clear-btn">清空</button>
        </div>

        <hr>

        <!-- 檔案上傳區塊 -->
        <h2>上傳影音檔</h2>
        <div class="btn-group">
            <input type="file" id="file-upload" accept="audio/*,video/*" style="flex-grow: 1;">
            <button id="upload-btn">上傳</button>
        </div>

        <hr>

        <!-- 檔案列表與播放區塊 -->
        <h2>我的檔案列表</h2>
        <ul id="file-list">
            <!-- 檔案會動態載入到這裡 -->
        </ul>
        
        <!-- 播放器 -->
        <h2>播放器</h2>
        <audio id="audio-player" controls></audio>

        <!-- 通知區塊 -->
        <div id="notification"></div>
    </div>

    <script>
        // --- 核心 JavaScript 邏輯 ---

        // 🚨 安全警告：請不要將你的金鑰公開！這段程式碼僅供測試用途。
        const GEMINI_API_KEY = "AIzaSyBRDwcceJ4PhOsie2gso3TU6XDH9wQq-p0"; 

        // 取得所有 DOM 元素
        const convertBtn = document.getElementById('convert-btn');
        const clearBtn = document.getElementById('clear-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const textInput = document.getElementById('text-input');
        const fileUpload = document.getElementById('file-upload');
        const fileList = document.getElementById('file-list');
        const audioPlayer = document.getElementById('audio-player');
        const notification = document.getElementById('notification');

        // 從 localStorage 載入已儲存的檔案資訊，若無則為空陣列
        let files = JSON.parse(localStorage.getItem('podcastFiles')) || [];

        /**
         * 顯示通知訊息
         * @param {string} message - 要顯示的訊息
         * @param {boolean} isSuccess - 是否為成功訊息
         */
        function showNotification(message, isSuccess = true) {
            notification.textContent = message;
            notification.style.backgroundColor = isSuccess ? '#e6f7ff' : '#fff1f0';
            notification.style.color = isSuccess ? '#357bd8' : '#cf1322';
            notification.style.display = 'block';
            // 自動隱藏通知
            setTimeout(() => { notification.style.display = 'none'; }, 5000);
        }

        /**
         * 重新渲染檔案列表
         */
        function renderFiles() {
            fileList.innerHTML = '';
            if (files.length === 0) {
                fileList.innerHTML = '<li>目前沒有任何檔案。</li>';
                return;
            }

            files.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div class="file-info">
                        <span>${file.name}</span>
                    </div>
                    <div class="file-actions">
                        <button onclick="playFile('${file.url}')">播放</button>
                        <a href="${file.url}" download="${file.name}">
                            <button>下載</button>
                        </a>
                        <button onclick="deleteFile(${index})">刪除</button>
                    </div>
                `;
                fileList.appendChild(li);
            });
        }

        /**
         * 儲存檔案列表到 localStorage
         */
        function saveFiles() {
            localStorage.setItem('podcastFiles', JSON.stringify(files));
        }

        /**
         * 播放選定的檔案
         * @param {string} url - 檔案的 URL (通常是 Blob URL)
         */
        window.playFile = function(url) {
            audioPlayer.src = url;
            audioPlayer.play();
            showNotification('正在播放音檔...');
        };

        /**
         * 刪除檔案並從列表中移除
         * @param {number} index - 要刪除的檔案在陣列中的索引
         */
        window.deleteFile = function(index) {
            if (index < 0 || index >= files.length) return;
            
            // 如果是透過 URL.createObjectURL 創建的，則釋放記憶體
            if (files[index].url.startsWith('blob:')) {
                URL.revokeObjectURL(files[index].url);
            }

            files.splice(index, 1);
            saveFiles();
            renderFiles();
            showNotification('檔案已成功刪除。');
        };

        /**
         * 將 Base64 字符串轉換為 ArrayBuffer
         * @param {string} base64 - Base64 編碼的字符串
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * 將 PCM 原始音頻資料轉換為可播放的 WAV Blob
         * @param {Int16Array} pcmData - PCM 16-bit 音頻數據
         * @param {number} sampleRate - 採樣率
         * @returns {Blob} - WAV 格式的 Blob
         */
        function pcmToWav(pcmData, sampleRate) {
            const numSamples = pcmData.length;
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            }

            function writeUint32(val) {
                view.setUint32(offset, val, true);
                offset += 4;
            }

            function writeUint16(val) {
                view.setUint16(offset, val, true);
                offset += 2;
            }

            // RIFF chunk
            writeString('RIFF');
            writeUint32(36 + numSamples * 2); // 總檔案大小
            writeString('WAVE');

            // fmt chunk
            writeString('fmt ');
            writeUint32(16); // chunk 大小
            writeUint16(1);  // 音頻格式 (1 = PCM)
            writeUint16(1);  // 聲道數 (1 = 單聲道)
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2); // 位元組率
            writeUint16(2);  // 區塊對齊
            writeUint16(16); // 每個採樣的位元數

            // data chunk
            writeString('data');
            writeUint32(numSamples * 2); // 資料大小
            
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        /**
         * 將文字轉換成音檔
         */
        async function convertToPodcast() {
            const text = textInput.value.trim();
            if (!text) {
                showNotification('請輸入文字！', false);
                return;
            }

            convertBtn.disabled = true;
            showNotification('轉換中，請稍候...');

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Puck" } // 你可以選擇其他聲音
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API 呼叫失敗：${response.status} ${errorText}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (!audioData || !mimeType) {
                    throw new Error('API 回傳資料不完整。');
                }
                
                // 從 MIME Type 中提取採樣率
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;

                // 轉換 Base64 PCM 資料到 WAV Blob
                const pcmArrayBuffer = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmArrayBuffer);
                const wavBlob = pcmToWav(pcm16, sampleRate);

                const audioUrl = URL.createObjectURL(wavBlob);
                const fileName = `podcast_${Date.now()}.wav`;

                // 將新檔案添加到列表並儲存
                files.push({ name: fileName, url: audioUrl });
                saveFiles();

                showNotification('轉換成功！');
                renderFiles();

            } catch (error) {
                console.error('Error converting text:', error);
                showNotification(`轉換失敗：${error.message}`, false);
            } finally {
                convertBtn.disabled = false;
            }
        }

        /**
         * 上傳檔案並加入列表
         */
        function uploadFile() {
            const file = fileUpload.files[0];
            if (!file) {
                showNotification('請選擇一個檔案！', false);
                return;
            }

            const fileUrl = URL.createObjectURL(file);
            files.push({ name: file.name, url: fileUrl });
            saveFiles();
            showNotification('檔案上傳成功！');
            renderFiles();
            fileUpload.value = ''; // 清空上傳欄位
        }

        /**
         * 清空文字輸入框
         */
        function clearText() {
            textInput.value = '';
        }

        // --- 事件監聽器 ---
        convertBtn.addEventListener('click', convertToPodcast);
        clearBtn.addEventListener('click', clearText);
        uploadBtn.addEventListener('click', uploadFile);

        // 網頁載入時初始化
        document.addEventListener('DOMContentLoaded', renderFiles);
    </script>
</body>
</html>
