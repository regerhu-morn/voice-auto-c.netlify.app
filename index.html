<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—è½‰ Podcast (Gemini)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* åŸºç¤æ¨£å¼å’ŒéŸ¿æ‡‰å¼è¨­è¨ˆ */
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 900px; margin: auto; padding: 30px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); }
        
        /* æ¨™é¡Œèˆ‡åˆ†éš”ç·š */
        h1, h2 { color: #2c3e50; font-weight: 600; margin-top: 0; }
        hr { border: none; border-top: 1px solid #e0e0e0; margin: 30px 0; }
        
        /* è¼¸å…¥èˆ‡æŒ‰éˆ•æ¨£å¼ */
        textarea { width: 100%; height: 120px; margin-bottom: 15px; padding: 15px; border: 1px solid #dcdfe6; border-radius: 8px; font-size: 16px; resize: vertical; box-sizing: border-box; transition: border-color 0.3s; }
        textarea:focus { outline: none; border-color: #4a90e2; }
        button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; background-color: #4a90e2; color: #fff; font-size: 16px; font-weight: 600; transition: background-color 0.3s, transform 0.2s; }
        button:hover { background-color: #357bd8; transform: translateY(-2px); }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }

        /* æª”æ¡ˆåˆ—è¡¨èˆ‡é …ç›®æ¨£å¼ */
        #file-list { list-style: none; padding: 0; margin: 0; }
        .file-item { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .file-item:last-child { border-bottom: none; }
        .file-info { flex-grow: 1; min-width: 0; word-break: break-all; margin-right: 10px; }
        .file-actions { display: flex; flex-shrink: 0; gap: 8px; }
        
        /* æ’­æ”¾å™¨èˆ‡é€šçŸ¥ */
        audio { width: 100%; margin-top: 20px; }
        #notification { padding: 15px; margin-top: 20px; border-radius: 8px; background-color: #e6f7ff; color: #357bd8; text-align: center; display: none; }
        
        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 600px) {
            .container { padding: 20px; }
            .btn-group { flex-direction: column; }
            .file-item { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ–‡å­—è½‰ Podcast (Gemini)</h1>
        
        <!-- æ–‡å­—è½‰èªéŸ³å€å¡Š -->
        <textarea id="text-input" placeholder="è«‹è¼¸å…¥æ‚¨æƒ³è½‰æ›æˆ Podcast çš„æ–‡å­—..."></textarea>
        <div class="btn-group">
            <button id="convert-btn">è½‰æ›æˆéŸ³æª”</button>
            <button id="clear-btn">æ¸…ç©º</button>
        </div>

        <hr>

        <!-- æª”æ¡ˆä¸Šå‚³å€å¡Š -->
        <h2>ä¸Šå‚³å½±éŸ³æª”</h2>
        <div class="btn-group">
            <input type="file" id="file-upload" accept="audio/*,video/*" style="flex-grow: 1;">
            <button id="upload-btn">ä¸Šå‚³</button>
        </div>

        <hr>

        <!-- æª”æ¡ˆåˆ—è¡¨èˆ‡æ’­æ”¾å€å¡Š -->
        <h2>æˆ‘çš„æª”æ¡ˆåˆ—è¡¨</h2>
        <ul id="file-list">
            <!-- æª”æ¡ˆæœƒå‹•æ…‹è¼‰å…¥åˆ°é€™è£¡ -->
        </ul>
        
        <!-- æ’­æ”¾å™¨ -->
        <h2>æ’­æ”¾å™¨</h2>
        <audio id="audio-player" controls></audio>

        <!-- é€šçŸ¥å€å¡Š -->
        <div id="notification"></div>
    </div>

    <script>
        // --- æ ¸å¿ƒ JavaScript é‚è¼¯ ---

        // ğŸš¨ å®‰å…¨è­¦å‘Šï¼šè«‹ä¸è¦å°‡ä½ çš„é‡‘é‘°å…¬é–‹ï¼é€™æ®µç¨‹å¼ç¢¼åƒ…ä¾›æ¸¬è©¦ç”¨é€”ã€‚
        const GEMINI_API_KEY = "AIzaSyBRDwcceJ4PhOsie2gso3TU6XDH9wQq-p0"; 

        // å–å¾—æ‰€æœ‰ DOM å…ƒç´ 
        const convertBtn = document.getElementById('convert-btn');
        const clearBtn = document.getElementById('clear-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const textInput = document.getElementById('text-input');
        const fileUpload = document.getElementById('file-upload');
        const fileList = document.getElementById('file-list');
        const audioPlayer = document.getElementById('audio-player');
        const notification = document.getElementById('notification');

        // å¾ localStorage è¼‰å…¥å·²å„²å­˜çš„æª”æ¡ˆè³‡è¨Šï¼Œè‹¥ç„¡å‰‡ç‚ºç©ºé™£åˆ—
        let files = JSON.parse(localStorage.getItem('podcastFiles')) || [];

        /**
         * é¡¯ç¤ºé€šçŸ¥è¨Šæ¯
         * @param {string} message - è¦é¡¯ç¤ºçš„è¨Šæ¯
         * @param {boolean} isSuccess - æ˜¯å¦ç‚ºæˆåŠŸè¨Šæ¯
         */
        function showNotification(message, isSuccess = true) {
            notification.textContent = message;
            notification.style.backgroundColor = isSuccess ? '#e6f7ff' : '#fff1f0';
            notification.style.color = isSuccess ? '#357bd8' : '#cf1322';
            notification.style.display = 'block';
            // è‡ªå‹•éš±è—é€šçŸ¥
            setTimeout(() => { notification.style.display = 'none'; }, 5000);
        }

        /**
         * é‡æ–°æ¸²æŸ“æª”æ¡ˆåˆ—è¡¨
         */
        function renderFiles() {
            fileList.innerHTML = '';
            if (files.length === 0) {
                fileList.innerHTML = '<li>ç›®å‰æ²’æœ‰ä»»ä½•æª”æ¡ˆã€‚</li>';
                return;
            }

            files.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div class="file-info">
                        <span>${file.name}</span>
                    </div>
                    <div class="file-actions">
                        <button onclick="playFile('${file.url}')">æ’­æ”¾</button>
                        <a href="${file.url}" download="${file.name}">
                            <button>ä¸‹è¼‰</button>
                        </a>
                        <button onclick="deleteFile(${index})">åˆªé™¤</button>
                    </div>
                `;
                fileList.appendChild(li);
            });
        }

        /**
         * å„²å­˜æª”æ¡ˆåˆ—è¡¨åˆ° localStorage
         */
        function saveFiles() {
            localStorage.setItem('podcastFiles', JSON.stringify(files));
        }

        /**
         * æ’­æ”¾é¸å®šçš„æª”æ¡ˆ
         * @param {string} url - æª”æ¡ˆçš„ URL (é€šå¸¸æ˜¯ Blob URL)
         */
        window.playFile = function(url) {
            audioPlayer.src = url;
            audioPlayer.play();
            showNotification('æ­£åœ¨æ’­æ”¾éŸ³æª”...');
        };

        /**
         * åˆªé™¤æª”æ¡ˆä¸¦å¾åˆ—è¡¨ä¸­ç§»é™¤
         * @param {number} index - è¦åˆªé™¤çš„æª”æ¡ˆåœ¨é™£åˆ—ä¸­çš„ç´¢å¼•
         */
        window.deleteFile = function(index) {
            if (index < 0 || index >= files.length) return;
            
            // å¦‚æœæ˜¯é€é URL.createObjectURL å‰µå»ºçš„ï¼Œå‰‡é‡‹æ”¾è¨˜æ†¶é«”
            if (files[index].url.startsWith('blob:')) {
                URL.revokeObjectURL(files[index].url);
            }

            files.splice(index, 1);
            saveFiles();
            renderFiles();
            showNotification('æª”æ¡ˆå·²æˆåŠŸåˆªé™¤ã€‚');
        };

        /**
         * å°‡ Base64 å­—ç¬¦ä¸²è½‰æ›ç‚º ArrayBuffer
         * @param {string} base64 - Base64 ç·¨ç¢¼çš„å­—ç¬¦ä¸²
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * å°‡ PCM åŸå§‹éŸ³é »è³‡æ–™è½‰æ›ç‚ºå¯æ’­æ”¾çš„ WAV Blob
         * @param {Int16Array} pcmData - PCM 16-bit éŸ³é »æ•¸æ“š
         * @param {number} sampleRate - æ¡æ¨£ç‡
         * @returns {Blob} - WAV æ ¼å¼çš„ Blob
         */
        function pcmToWav(pcmData, sampleRate) {
            const numSamples = pcmData.length;
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            }

            function writeUint32(val) {
                view.setUint32(offset, val, true);
                offset += 4;
            }

            function writeUint16(val) {
                view.setUint16(offset, val, true);
                offset += 2;
            }

            // RIFF chunk
            writeString('RIFF');
            writeUint32(36 + numSamples * 2); // ç¸½æª”æ¡ˆå¤§å°
            writeString('WAVE');

            // fmt chunk
            writeString('fmt ');
            writeUint32(16); // chunk å¤§å°
            writeUint16(1);  // éŸ³é »æ ¼å¼ (1 = PCM)
            writeUint16(1);  // è²é“æ•¸ (1 = å–®è²é“)
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2); // ä½å…ƒçµ„ç‡
            writeUint16(2);  // å€å¡Šå°é½Š
            writeUint16(16); // æ¯å€‹æ¡æ¨£çš„ä½å…ƒæ•¸

            // data chunk
            writeString('data');
            writeUint32(numSamples * 2); // è³‡æ–™å¤§å°
            
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        /**
         * å°‡æ–‡å­—è½‰æ›æˆéŸ³æª”
         */
        async function convertToPodcast() {
            const text = textInput.value.trim();
            if (!text) {
                showNotification('è«‹è¼¸å…¥æ–‡å­—ï¼', false);
                return;
            }

            convertBtn.disabled = true;
            showNotification('è½‰æ›ä¸­ï¼Œè«‹ç¨å€™...');

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Puck" } // ä½ å¯ä»¥é¸æ“‡å…¶ä»–è²éŸ³
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API å‘¼å«å¤±æ•—ï¼š${response.status} ${errorText}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (!audioData || !mimeType) {
                    throw new Error('API å›å‚³è³‡æ–™ä¸å®Œæ•´ã€‚');
                }
                
                // å¾ MIME Type ä¸­æå–æ¡æ¨£ç‡
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;

                // è½‰æ› Base64 PCM è³‡æ–™åˆ° WAV Blob
                const pcmArrayBuffer = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmArrayBuffer);
                const wavBlob = pcmToWav(pcm16, sampleRate);

                const audioUrl = URL.createObjectURL(wavBlob);
                const fileName = `podcast_${Date.now()}.wav`;

                // å°‡æ–°æª”æ¡ˆæ·»åŠ åˆ°åˆ—è¡¨ä¸¦å„²å­˜
                files.push({ name: fileName, url: audioUrl });
                saveFiles();

                showNotification('è½‰æ›æˆåŠŸï¼');
                renderFiles();

            } catch (error) {
                console.error('Error converting text:', error);
                showNotification(`è½‰æ›å¤±æ•—ï¼š${error.message}`, false);
            } finally {
                convertBtn.disabled = false;
            }
        }

        /**
         * ä¸Šå‚³æª”æ¡ˆä¸¦åŠ å…¥åˆ—è¡¨
         */
        function uploadFile() {
            const file = fileUpload.files[0];
            if (!file) {
                showNotification('è«‹é¸æ“‡ä¸€å€‹æª”æ¡ˆï¼', false);
                return;
            }

            const fileUrl = URL.createObjectURL(file);
            files.push({ name: file.name, url: fileUrl });
            saveFiles();
            showNotification('æª”æ¡ˆä¸Šå‚³æˆåŠŸï¼');
            renderFiles();
            fileUpload.value = ''; // æ¸…ç©ºä¸Šå‚³æ¬„ä½
        }

        /**
         * æ¸…ç©ºæ–‡å­—è¼¸å…¥æ¡†
         */
        function clearText() {
            textInput.value = '';
        }

        // --- äº‹ä»¶ç›£è½å™¨ ---
        convertBtn.addEventListener('click', convertToPodcast);
        clearBtn.addEventListener('click', clearText);
        uploadBtn.addEventListener('click', uploadFile);

        // ç¶²é è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', renderFiles);
    </script>
</body>
</html>
