<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的 Podcast 產生器</title>

    <!-- Tailwind CSS 腳本，用於美化頁面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 使用 Google Fonts 的 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center font-sans">

    <!-- 這是應用程式的主要容器，將所有 UI 元素動態新增到此處 -->
    <div id="app-container" class="bg-white rounded-xl shadow-lg p-6 sm:p-10 w-full max-w-3xl"></div>

    <!-- 主應用程式腳本 -->
    <script type="module">
        let allFiles = JSON.parse(localStorage.getItem('podcastFiles')) || [];
        let categories = JSON.parse(localStorage.getItem('podcastCategories')) || [];
        let displayedFiles = [...allFiles];
        let audioUrl = '';
        let playbackRate = 1.0;
        let audioRef = new Audio();
        let isConverting = false;
        let currentCategory = '';
        let isPlaying = false;

        // 定義可供選擇的語音選項
        const voiceOptions = [
            { name: "美式男聲 (Orus)", value: "Orus" },
            { name: "美式女聲 (Vindemiatrix)", value: "Vindemiatrix" }
        ];
        
        // --- 工具函式 ---

        // 將 Base64 轉換為 ArrayBuffer
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        // 將 PCM 資料轉換為 WAV 格式
        const pcmToWav = (pcmData, sampleRate) => {
            const pcm16 = new Int16Array(pcmData);
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            
            // WAV 標頭
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            const format = 1; // PCM
            const channels = 1; // 單聲道
            const bitsPerSample = 16;
            const byteRate = sampleRate * channels * bitsPerSample / 8;
            const blockAlign = channels * bitsPerSample / 8;

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');

            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, channels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);

            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);
            
            // 寫入 PCM 資料
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }
            
            return new Blob([view], { type: 'audio/wav' });
        };
        
        const showMessage = (text) => {
            const messageEl = document.getElementById('message-box');
            if (messageEl) {
                messageEl.textContent = text;
                messageEl.style.display = 'block';
            }
        };

        const renderUI = () => {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            if (currentCategory) {
                displayedFiles = allFiles.filter(file => file.category === currentCategory);
            } else {
                displayedFiles = [...allFiles];
            }
            
            appContainer.innerHTML = `
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">我的 Podcast 產生器</h1>
                <div id="message-box" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-md" role="alert" style="display: none;"></div>

                <!-- 資料夾管理區塊 -->
                <h2 class="text-xl font-semibold text-gray-700 mb-3">管理資料夾</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                    <input id="new-category-input" type="text" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200" placeholder="新增資料夾名稱...">
                    <button id="add-category-btn" class="px-6 py-2 rounded-lg text-white font-medium bg-gray-600 hover:bg-gray-700 transition-all duration-200">新增</button>
                </div>

                <!-- 檔案操作區塊 - 選擇資料夾 -->
                <h2 class="text-xl font-semibold text-gray-700 mb-3">選擇資料夾</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                    <select id="category-select" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200">
                        <option value="">-- 顯示所有檔案 --</option>
                        ${categories.map(cat => `<option value="${cat.name}" ${cat.name === currentCategory ? 'selected' : ''}>${cat.name}</option>`).join('')}
                    </select>
                    <button id="delete-category-btn" class="px-6 py-2 rounded-lg text-white font-medium bg-red-600 hover:bg-red-700 transition-all duration-200">刪除選定資料夾</button>
                </div>

                <!-- 文字轉語音區塊 -->
                <h2 class="text-xl font-semibold text-gray-700 mb-3">文字轉語音</h2>
                <div class="flex flex-col gap-4 mb-6">
                    <!-- 語音選擇器 -->
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 font-medium whitespace-nowrap">選擇語音:</label>
                        <select id="voice-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200">
                           ${voiceOptions.map(voice => `<option value="${voice.value}">${voice.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <textarea id="text-input" class="flex-grow p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all duration-200 resize-none" placeholder="輸入您想轉換的文字..." rows="4"></textarea>
                        <button id="convert-btn" class="px-6 py-2 rounded-lg text-white font-medium transition-all duration-200 bg-blue-600 hover:bg-blue-700">轉換並儲存</button>
                    </div>
                </div>

                <!-- 檔案上傳區塊 -->
                <h2 class="text-xl font-semibold text-gray-700 mb-3">上傳音檔</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                    <input id="file-upload-input" type="file" accept="audio/*" class="flex-grow text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button id="upload-btn" class="px-6 py-2 rounded-lg text-white font-medium transition-all duration-200 bg-gray-600 hover:bg-gray-700">上傳檔案</button>
                </div>

                <!-- 播放器與速度調整 -->
                <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2 sm:mb-0">播放器</h2>
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 font-medium">播放速度:</label>
                        <select id="playback-rate-select" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-200">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1.0" selected>1.0x (標準)</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="1.75">1.75x</option>
                            <option value="2.0">2.0x</option>
                        </select>
                    </div>
                </div>
                <audio id="audio-player" controls class="w-full"></audio>

                <!-- 檔案列表 -->
                <h2 class="text-xl font-semibold text-gray-700 mt-6 mb-3">我的檔案列表</h2>
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <ul id="files-list" class="divide-y divide-gray-200">
                        ${displayedFiles.length > 0 ? displayedFiles.map(file => `
                            <li class="py-3 flex flex-col sm:flex-row items-start sm:items-center justify-between">
                                <div class="sm:truncate sm:flex-1 mb-2 sm:mb-0 mr-4">
                                    <span class="text-gray-800 font-medium">${file.name}</span>
                                    ${file.category ? `<span class="text-xs text-gray-500 ml-2 px-2 py-1 bg-gray-200 rounded-full">${file.category}</span>` : ''}
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button class="play-btn px-4 py-2 rounded-md bg-green-500 text-white text-sm hover:bg-green-600 transition-colors duration-200" data-url="${file.url}">播放</button>
                                    <a href="${file.url}" download="${file.name}">
                                        <button class="px-4 py-2 rounded-md bg-indigo-500 text-white text-sm hover:bg-indigo-600 transition-colors duration-200">下載</button>
                                    </a>
                                    <button class="delete-btn px-4 py-2 rounded-md bg-red-500 text-white text-sm hover:bg-red-600 transition-colors duration-200" data-id="${file.id}" data-url="${file.url}">刪除</button>
                                </div>
                            </li>
                        `).join('') : '<p class="text-gray-500 italic">目前沒有任何檔案。請轉換文字或上傳檔案。</p>'}
                    </ul>
                </div>
            `;
            
            // 重新繫結事件監聽器
            setupEventListeners();
        };

        const setupEventListeners = () => {
            const addCategoryBtn = document.getElementById('add-category-btn');
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener('click', handleAddCategory);
            }

            const deleteCategoryBtn = document.getElementById('delete-category-btn');
            if (deleteCategoryBtn) {
                deleteCategoryBtn.addEventListener('click', handleDeleteCategory);
            }

            const convertBtn = document.getElementById('convert-btn');
            if (convertBtn) {
                convertBtn.addEventListener('click', handleConvert);
            }
            
            const uploadBtn = document.getElementById('upload-btn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', handleUpload);
            }

            const playbackRateSelect = document.getElementById('playback-rate-select');
            if (playbackRateSelect) {
                playbackRateSelect.value = playbackRate;
                playbackRateSelect.addEventListener('change', (e) => {
                    playbackRate = parseFloat(e.target.value);
                    if (audioRef) {
                        audioRef.playbackRate = playbackRate;
                    }
                });
            }

            const categorySelect = document.getElementById('category-select');
            if (categorySelect) {
                categorySelect.addEventListener('change', handleCategoryFilter);
            }

            const audioPlayer = document.getElementById('audio-player');
            if (audioPlayer) {
                audioRef = audioPlayer;
                if (audioUrl) {
                    audioRef.src = audioUrl;
                }
                audioRef.playbackRate = playbackRate;
            }
            
            const filesList = document.getElementById('files-list');
            if (filesList) {
                filesList.querySelectorAll('.play-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const url = e.target.dataset.url;
                        audioUrl = url;
                        audioRef.src = audioUrl;
                        audioRef.play();
                        showMessage("正在播放音檔...");
                    });
                });
                filesList.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const url = e.target.dataset.url;
                        handleDelete(id, url);
                    });
                });
            }
        };

        // --- 功能函式 ---

        const saveToLocalStorage = () => {
            localStorage.setItem('podcastFiles', JSON.stringify(allFiles));
            localStorage.setItem('podcastCategories', JSON.stringify(categories));
        };

        const handleCategoryFilter = () => {
            const selectedCategory = document.getElementById('category-select').value;
            currentCategory = selectedCategory;
            renderUI();
        };

        const handleAddCategory = () => {
            const newCategoryInput = document.getElementById('new-category-input');
            const newCategoryName = newCategoryInput.value.trim();
            if (!newCategoryName) {
                showMessage("請輸入資料夾名稱！");
                return;
            }

            const newCategory = { id: Date.now(), name: newCategoryName };
            categories.push(newCategory);
            saveToLocalStorage();
            newCategoryInput.value = '';
            currentCategory = newCategoryName;
            renderUI();
            showMessage(`已新增資料夾：${newCategoryName}`);
        };

        const handleDeleteCategory = () => {
            const selectedCategory = document.getElementById('category-select').value;
            if (!selectedCategory) {
                showMessage("請先選擇一個資料夾才能刪除！");
                return;
            }

            const confirmation = window.confirm(`你確定要刪除資料夾「${selectedCategory}」嗎？這個動作將同時刪除所有屬於這個資料夾的檔案，且無法復原！`);
            
            if (confirmation) {
                allFiles = allFiles.filter(file => file.category !== selectedCategory);
                categories = categories.filter(cat => cat.name !== selectedCategory);

                currentCategory = '';
                saveToLocalStorage();
                renderUI();
                showMessage(`資料夾「${selectedCategory}」及其所有檔案已刪除！`);
            }
        };

        const handleConvert = async () => {
            const textInputEl = document.getElementById('text-input');
            const textInput = textInputEl.value.trim();
            const selectedCategory = document.getElementById('category-select').value;
            const selectedVoiceName = document.getElementById('voice-select').value;
            
            if (isConverting) {
                return;
            }

            if (!textInput) {
                showMessage("請輸入您想轉換的文字！");
                return;
            }

            if (!selectedCategory) {
                showMessage("請先選擇一個資料夾！");
                return;
            }

            isConverting = true;
            const convertBtn = document.getElementById('convert-btn');
            convertBtn.textContent = '轉換中...';
            convertBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            convertBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            convertBtn.disabled = true;
            showMessage("轉換中...請稍候...");
            
            try {
                const payload = {
                    contents: [{
                        parts: [{ text: textInput }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                // 使用使用者選擇的語音名稱
                                prebuiltVoiceConfig: { voiceName: selectedVoiceName }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const apiKey = ""; // API 金鑰將由系統自動提供
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API 錯誤: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (!audioData || !mimeType || !mimeType.startsWith("audio/")) {
                    throw new Error("API 回傳資料不完整。");
                }
                
                const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const wavBlob = pcmToWav(pcmData, sampleRate);
                const fileUrl = URL.createObjectURL(wavBlob);
                
                const fileName = `Podcast_${Date.now()}.wav`;

                const newFile = {
                    id: Date.now(),
                    name: fileName,
                    url: fileUrl,
                    category: selectedCategory,
                };

                allFiles.unshift(newFile);
                saveToLocalStorage();
                currentCategory = selectedCategory;
                renderUI();

                showMessage("轉換並儲存成功！");
                textInputEl.value = '';

            } catch (error) {
                console.error("轉換失敗:", error);
                showMessage(`轉換失敗: ${error.message}。請稍後再試。`);
            } finally {
                isConverting = false;
                convertBtn.textContent = '轉換並儲存';
                convertBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                convertBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                convertBtn.disabled = false;
            }
        };

        const handleUpload = () => {
            const fileInput = document.getElementById('file-upload-input');
            const file = fileInput.files[0];
            const selectedCategory = document.getElementById('category-select').value;
            
            if (!file) {
                showMessage("請先選擇一個檔案！");
                return;
            }
            if (!selectedCategory) {
                showMessage("請先選擇一個資料夾！");
                return;
            }

            showMessage("上傳中...");
            
            try {
                const fileUrl = URL.createObjectURL(file);
                const fileName = file.name;

                const newFile = {
                    id: Date.now(),
                    name: fileName,
                    url: fileUrl,
                    category: selectedCategory,
                };

                allFiles.unshift(newFile);
                saveToLocalStorage();
                currentCategory = selectedCategory;
                renderUI();

                showMessage("上傳成功！");
            } catch (error) {
                console.error("上傳失敗:", error);
                showMessage(`上傳失敗: ${error.message}`);
            }
        };

        const handleDelete = (id, url) => {
            allFiles = allFiles.filter(file => file.id != id);
            saveToLocalStorage();
            if (url && url !== '#') {
                URL.revokeObjectURL(url);
            }
            handleCategoryFilter();
            renderUI();
            showMessage("檔案已刪除！");
        };

        // --- 應用程式初始化 ---
        window.onload = () => {
            const lastCategory = localStorage.getItem('lastCategory');
            if (lastCategory) {
                currentCategory = lastCategory;
            }
            renderUI();
        };
    </script>
</body>
</html>
